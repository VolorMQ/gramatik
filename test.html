<!DOCTYPE html>
<html lang="da">
<head>
<meta charset="UTF-8">
<title>Fill-in-the-blank interactive</title>
<meta name="viewport" content="width=device-width,initial-scale=1.0">
<style>
body { font-family: Arial, sans-serif; background: #f2f2f2; padding: 30px; }
h2 { color: #333; }
#story { margin-bottom: 20px; line-height: 1.6; font-size: 18px; }
.placeholder, .insertedWord {
  display: inline-block;
  min-width: 60px;
  padding: 5px;
  margin: 0 3px;
  border-bottom: 2px solid #555;
  vertical-align: middle;
  text-align: center;
}
.placeholder { background: #fff; cursor: grab; }
.insertedWord { background: #2196F3; color: #fff; cursor: grab; border-radius: 4px; }
#choices {
  margin-top: 20px;
  min-height: 50px;
  padding: 10px;
  border: 1px solid #ccc;
  background: #e9e9e9;
  border-radius: 5px;
  text-align: center;
}
.word {
  display: inline-block;
  padding: 8px 12px;
  margin: 5px;
  background: #4CAF50;
  color: #fff;
  border-radius: 5px;
  cursor: grab;
  user-select: none;
}
.word.dragging, .insertedWord.dragging { opacity: 0.5; }
#controls { margin-bottom: 15px; }
#check, #refresh, #generateWords { margin-top: 10px; padding: 10px 20px; font-size: 16px; cursor: pointer; margin-right: 10px;}
#result { margin-top: 15px; font-weight: bold; font-size: 18px; text-align:center;}
label { margin-right: 10px; }
@media (max-width: 600px) {
  body { padding: 12px; }
  .word, .insertedWord { font-size: 16px; padding: 6px 10px; }
}
</style>
</head>
<body>

<h2>Udfyld de manglende ord:</h2>

<div id="controls">
  <label>Antal ord til at inds√¶tte: <input type="number" id="numWords" min="1" max="10" value="3"></label>
  <label><input type="checkbox" id="mobileMode"> Mobiltilstand</label>
  <button id="generateWords">Generer ord</button>
  <button id="refresh">Opdater tekst</button>
  <button id="check">Check</button>
</div>

<div id="story"></div>
<div id="choices"></div>
<div id="result"></div>

<script>
let texts = [];
let currentText = null;
let availableWords = [];
let selectedWords = [];
let dragged = null;
let fromChoice = false;
let mobileMode = false;
let selectedWordForTap = null;

// –ó–∞–≥—Ä—É–∑–∫–∞ JSON —Å —Ä–∞—Å—Å–∫–∞–∑–∞–º–∏
fetch('texts.json')
  .then(res => res.json())
  .then(data => {
    texts = data;
    loadRandomText();
  })
  .catch(()=> {
    // –µ—Å–ª–∏ –Ω–µ—Ç —Ñ–∞–π–ª–∞, –º–æ–∂–Ω–æ –∑–∞–¥–∞—Ç—å fallback —Ç–µ–∫—Å—Ç
    texts = [{ text: "I morges sprang jeg hurtigt ud af sengen, og pr√∏vede jeg at finde mine sko, men de l√• gemt under sofaen. Da jeg endelig fandt dem, l√∏b jeg ud af d√∏ren og n√•ede lige bussen i sidste √∏jeblik." }];
    loadRandomText();
  });

// –°–ª—É—á–∞–π–Ω—ã–π –≤—ã–±–æ—Ä —Ç–µ–∫—Å—Ç–∞
function loadRandomText() {
  const randomIndex = Math.floor(Math.random() * texts.length);
  currentText = JSON.parse(JSON.stringify(texts[randomIndex])); // –≥–ª—É–±–æ–∫–∞—è –∫–æ–ø–∏—è
  generateWords();
}

// –ü–µ—Ä–µ–º–µ—à–∏–≤–∞–Ω–∏–µ –º–∞—Å—Å–∏–≤–∞
function shuffleArray(arr) {
  return arr.slice().sort(() => Math.random() - 0.5);
}

// ---- helper: –ø–æ–ª—É—á–∏—Ç—å –≤—Å–µ —Å–ª–æ–≤–∞ (Unicode-aware) ----
function extractWords(text){
  try {
    // —Ä–∞–±–æ—Ç–∞–µ—Ç –≤ —Å–æ–≤—Ä–µ–º–µ–Ω–Ω—ã—Ö –±—Ä–∞—É–∑–µ—Ä–∞—Ö: –±–µ—Ä—ë–º –±—É–∫–≤—ã –∏ –∫–æ–º–±–∏–Ω–∞—Ü–∏–∏ –¥–∏–∞–∫—Ä–∏—Ç–∏–∫–∏
    return text.match(/[\p{L}\p{M}]+/gu) || [];
  } catch(e){
    // fallback ‚Äî —Å—Ç–∞—Ä—ã–µ –±—Ä–∞—É–∑–µ—Ä—ã: –¥–æ–±–∞–≤–∏–º √¶√∏√• –≤—Ä—É—á–Ω—É—é
    return text.match(/\b[\w√¶√∏√•√Ü√ò√Ö]+\b/g) || [];
  }
}

// ---- helper: —Ç–æ–∫–µ–Ω–∏–∑–∞—Ü–∏—è —Ç–µ–∫—Å—Ç–∞ (—Å–ª–æ–≤–∞ –∏ –≤—Å—ë –æ—Å—Ç–∞–ª—å–Ω–æ–µ) ----
function tokenize(text){
  try {
    return text.match(/[\p{L}\p{M}]+|[^\p{L}\p{M}]+/gu) || [text];
  } catch(e){
    // fallback: —Ä–∞–∑–±–∏–≤–∞–µ–º –Ω–∞ —Å–ª–æ–≤–∞/–Ω–µ-—Å–ª–æ–≤–∞ (—Å–æ—Ö—Ä–∞–Ω—è—è —Ä–∞–∑–¥–µ–ª–∏—Ç–µ–ª–∏)
    return text.split(/(\W+)/);
  }
}

// ---- –ì–µ–Ω–µ—Ä–∞—Ü–∏—è —Å–ª—É—á–∞–π–Ω—ã—Ö —Å–ª–æ–≤ –¥–ª—è –≤—Å—Ç–∞–≤–∫–∏ (–∑–∞–º–µ–Ω–∞ —Å—Ç–∞—Ä–æ–π —Ñ—É–Ω–∫—Ü–∏–∏) ----
function generateWords() {
  const num = parseInt(document.getElementById('numWords').value);

  // –ù–∞–¥—ë–∂–Ω–æ –∏–∑–≤–ª–µ–∫–∞–µ–º —Å–ª–æ–≤–∞ (Unicode-aware)
  let allWords = extractWords(currentText.text);
  if (!allWords) allWords = [];

  // –£–±–∏—Ä–∞–µ–º –¥—É–±–ª–∏–∫–∞—Ç—ã, —á—Ç–æ–±—ã —Å–ª–æ–≤–∞ –±—ã–ª–∏ —É–Ω–∏–∫–∞–ª—å–Ω—ã
  const uniqueWords = [...new Set(allWords)];

  // –í—ã–±–∏—Ä–∞–µ–º —Å–ª—É—á–∞–π–Ω—ã–µ —É–Ω–∏–∫–∞–ª—å–Ω—ã–µ —Å–ª–æ–≤–∞ (—Ä–æ–≤–Ω–æ num –∏–ª–∏ –º–µ–Ω—å—à–µ)
  selectedWords = shuffleArray(uniqueWords).slice(0, Math.min(num, uniqueWords.length));

  // –ö–æ–ø–∏—è –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –≤ —Å–ø–∏—Å–∫–µ
  availableWords = selectedWords.slice();

  renderStory();
  renderWords();
  document.getElementById('result').textContent = '';
}

// ---- –°–æ–∑–¥–∞–Ω–∏–µ —Ç–µ–∫—Å—Ç–∞ —Å placeholders, –∑–∞–º–µ–Ω—è–µ–º —Ç–æ–ª—å–∫–æ –û–î–ù–û (–ø–µ—Ä–≤–æ–µ) –≤—Ö–æ–∂–¥–µ–Ω–∏–µ –∫–∞–∂–¥–æ–≥–æ —Å–ª–æ–≤–∞ ----
function renderStory() {
  let newText = currentText.text;

  selectedWords.forEach(word => {
    const escapedWord = word.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
    // –∏—â–µ–º —Ç–æ–ª—å–∫–æ –ø–µ—Ä–≤–æ–µ –≤—Ö–æ–∂–¥–µ–Ω–∏–µ
    const regex = new RegExp(`\\b${escapedWord}\\b`);
    // –ø–æ–º–µ—â–∞–µ–º –æ–∂–∏–¥–∞–µ–º–æ–µ —Å–ª–æ–≤–æ –≤ data-expected (–≤ –Ω–∏–∂–Ω–µ–º —Ä–µ–≥–∏—Å—Ç—Ä–µ)
    const placeholderHTML = `<span class="placeholder" data-expected="${word.toLowerCase()}" ondrop="dropWord(event)" ondragover="allowDrop(event)" onclick="tapPlaceholder(event)">___</span>`;
    newText = newText.replace(regex, placeholderHTML);
  });

  document.getElementById('story').innerHTML = newText;
}

// –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –¥–æ—Å—Ç—É–ø–Ω—ã—Ö —Å–ª–æ–≤
function renderWords() {
  const choicesDiv = document.getElementById('choices');
  // –ø—Ä–∏ –º–æ–±–∏–ª–∫–µ —Å–ª–æ–≤–∞ –Ω–µ draggable
  choicesDiv.innerHTML = availableWords.map((w,i) =>
    `<div class="word" ${mobileMode ? '' : 'draggable="true"'} id="word${i}" ondragstart="dragWord(event)" onclick="tapWord(event)">${w}</div>`
  ).join('');
}

// Drag & Drop
function allowDrop(ev){ ev.preventDefault(); }

function dragWord(ev){
  if(mobileMode) return; // –≤ –º–æ–±–∏–ª–∫–µ drag –æ—Ç–∫–ª—é—á–∞–µ–º
  dragged = ev.target;
  fromChoice = true;
  ev.dataTransfer.setData("text", ev.target.textContent);
  ev.target.classList.add('dragging');
}

function dropWord(ev){
  if(mobileMode) return; // –≤ –º–æ–±–∏–ª–∫–µ drop –æ—Ç–∫–ª—é—á–∞–µ–º
  ev.preventDefault();
  const placeholder = ev.target;
  if(dragged){
    const expected = placeholder.dataset && placeholder.dataset.expected ? placeholder.dataset.expected : null;

    // —Å–æ–∑–¥–∞—ë–º span –∏ –∫–æ–ø–∏—Ä—É–µ–º expected
    const span = document.createElement('span');
    span.className = 'insertedWord';
    span.draggable = true;
    span.textContent = dragged.textContent.trim();
    if(expected) span.dataset.expected = expected;

    span.ondragstart = dragInsertedWord;
    span.onclick = tapInsertedWord;
    placeholder.parentNode.replaceChild(span, placeholder);

    if(fromChoice){
      const index = availableWords.indexOf(dragged.textContent);
      if(index > -1) availableWords.splice(index, 1);
      renderWords();
    }
  }
  if (dragged) dragged.classList.remove('dragging');
  dragged = null;
}

function dragInsertedWord(ev){
  if(mobileMode) return; // –≤ –º–æ–±–∏–ª–∫–µ –æ—Ç–∫–ª—é—á–∞–µ–º
  const wordEl = ev.target;
  dragged = wordEl;
  fromChoice = false;
  ev.dataTransfer.setData("text", wordEl.textContent);
  ev.target.classList.add('dragging');
  availableWords.push(wordEl.textContent);
  renderWords();
  const placeholder = document.createElement('span');
  placeholder.className = 'placeholder';
  placeholder.textContent = '___';
  placeholder.ondrop = dropWord;
  placeholder.ondragover = allowDrop;
  placeholder.onclick = tapPlaceholder;
  wordEl.parentNode.replaceChild(placeholder, wordEl);
  dragged = null;
}

// === MOBILE: tap handlers ===
function tapWord(ev){
  if(!mobileMode) return;
  const el = ev.currentTarget;
  const word = el.textContent.trim();
  if(selectedWordForTap === word){
    selectedWordForTap = null;
    el.style.background = ''; // —Å–±—Ä–æ—Å –ø–æ–¥—Å–≤–µ—Ç–∫–∏
  } else {
    selectedWordForTap = word;
    // –ø–æ–¥—Å–≤–µ—Ç–∏–º –≤—ã–±—Ä–∞–Ω–Ω–æ–µ
    document.querySelectorAll('#choices .word').forEach(w => w.style.background = '#4CAF50');
    el.style.background = '#1976D2';
  }
}

function tapPlaceholder(ev){
  if(!mobileMode) return;
  if(!selectedWordForTap) return;
  const placeholder = ev.target;
  const expected = placeholder.dataset && placeholder.dataset.expected ? placeholder.dataset.expected : null;

  const span = document.createElement('span');
  span.className = 'insertedWord';
  span.textContent = selectedWordForTap;
  if(expected) span.dataset.expected = expected;
  // –≤ –º–æ–±–∏–ª–∫–µ —Å–¥–µ–ª–∞–µ–º span –Ω–µ draggable, –Ω–æ –æ—Å—Ç–∞–≤–∏–º onclick –¥–ª—è –≤–æ–∑–≤—Ä–∞—Ç–∞
  span.draggable = false;
  span.onclick = tapInsertedWord;

  placeholder.parentNode.replaceChild(span, placeholder);

  const idx = availableWords.indexOf(selectedWordForTap);
  if(idx > -1) availableWords.splice(idx, 1);
  selectedWordForTap = null;
  renderWords();
}

function tapInsertedWord(ev){
  if(!mobileMode){
    // –≤ –¥–µ—Å–∫—Ç–æ–ø–µ –∫–ª–∏–∫ –ø–æ –≤—Å—Ç–∞–≤–ª–µ–Ω–Ω–æ–º—É –≤–æ–∑–≤—Ä–∞—â–∞—Ç—å –Ω–µ –±—É–¥–µ–º (drag handles it)
    return;
  }
  const el = ev.target;
  const word = el.textContent.trim();
  // –≤–µ—Ä–Ω—É—Ç—å –≤ –±–∞–Ω–∫
  availableWords.push(word);
  renderWords();
  // –∑–∞–º–µ–Ω–∏—Ç—å –Ω–∞ placeholder
  const placeholder = document.createElement('span');
  placeholder.className = 'placeholder';
  placeholder.textContent = '___';
  placeholder.ondrop = dropWord;
  placeholder.ondragover = allowDrop;
  placeholder.onclick = tapPlaceholder;
  el.parentNode.replaceChild(placeholder, el);
}

// –ü—Ä–æ–≤–µ—Ä–∫–∞ (–æ—Å—Ç–∞–≤–ª–µ–Ω–∞ –∫–∞–∫ –≤ —Ç–≤–æ—ë–º —Ä–∞–±–æ—á–µ–º –∫–æ–¥–µ ‚Äî —Å—Ä–∞–≤–Ω–µ–Ω–∏–µ –ø–æ –ø–æ–∑–∏—Ü–∏–∏)
document.getElementById('check').addEventListener('click', () => {
  const inserted = Array.from(document.querySelectorAll('.insertedWord'));
  let allCorrect = true;
  inserted.forEach((el, i) => {
    const actual = el.textContent.trim().toLowerCase();
    const expected = (el.dataset && el.dataset.expected) ? el.dataset.expected.toLowerCase() : (selectedWords[i] ? selectedWords[i].toLowerCase() : null);

    if(expected && actual === expected){
      el.style.background = '#d4edda';
      el.style.borderBottom = '2px solid green';
    } else {
      el.style.background = '#f8d7da';
      el.style.borderBottom = '2px solid red';
      allCorrect = false;
    }
  });

  document.getElementById('result').textContent = allCorrect ? 'Alle svar er korrekte! üéâ' : 'Nogle svar er forkerte. Pr√∏v igen.';
});

// –ö–Ω–æ–ø–∫–∏
document.getElementById('refresh').addEventListener('click', loadRandomText);
document.getElementById('generateWords').addEventListener('click', generateWords);
document.getElementById('mobileMode').addEventListener('change', (e) => {
  mobileMode = e.target.checked;
  selectedWordForTap = null;
  // –ø—Ä–∏ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–∏ —Ä–µ–∂–∏–º–∞: –¥–µ–ª–∞–µ–º renderWords —á—Ç–æ–±—ã –æ–±–Ω–æ–≤–∏—Ç—å draggable –∞—Ç—Ä–∏–±—É—Ç—ã –∏ —É–±—Ä–∞—Ç—å –ø–æ–¥—Å–≤–µ—Ç–∫–∏
  renderWords();
});
</script>

</body>
</html>
