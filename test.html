<!DOCTYPE html>
<html lang="da">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Fill-in-the-blank ‚Äî Mobile/Drag mode</title>
<style>
  body { font-family: Arial, sans-serif; background:#f2f2f2; margin:0; padding:18px; }
  h2 { text-align:center; color:#222; }
  #controls { display:flex; flex-wrap:wrap; gap:10px; align-items:center; justify-content:center; margin-bottom:12px; }
  #story { background:#fff; padding:18px; border-radius:10px; box-shadow:0 2px 6px rgba(0,0,0,.08); line-height:1.6; font-size:18px; margin-bottom:12px; }
  .placeholder, .insertedWord { display:inline-block; min-width:60px; padding:4px 6px; margin:0 3px; border-bottom:2px solid #555; text-align:center; vertical-align:middle; }
  .placeholder { background:#fff; cursor:pointer; }
  .insertedWord { background:#2196F3; color:#fff; border-radius:4px; cursor:pointer; }
  #choices { background:#e9e9e9; padding:12px; border-radius:8px; text-align:center; min-height:56px; }
  .word { display:inline-block; margin:6px; padding:8px 12px; background:#4CAF50; color:#fff; border-radius:6px; cursor:pointer; user-select:none; }
  .word.dragging, .insertedWord.dragging { opacity:.5; }
  button, input[type="number"] { font-size:15px; padding:8px 12px; border-radius:6px; border:1px solid #ccc; }
  label { font-size:15px; }
  #result { text-align:center; margin-top:12px; font-weight:600; }
  @media (max-width:600px){ #story{font-size:16px;} .word{font-size:15px;padding:6px 10px;} }
</style>
</head>
<body>

<h2>Udfyld de manglende ord</h2>

<div id="controls">
  <label>Antal ord: <input id="numWords" type="number" min="1" max="15" value="4" /></label>
  <label><input id="mobileMode" type="checkbox" /> Mobiltilstand (tap)</label>
  <button id="generateWords">Generer ord</button>
  <button id="refresh">Opdater tekst</button>
  <button id="check">Check</button>
</div>

<div id="story" aria-live="polite"></div>
<div id="choices" aria-label="Ord til inds√¶ttelse"></div>
<div id="result"></div>

<script>
// ----- –î–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏–æ–Ω–Ω—ã–µ —Ç–µ–∫—Å—Ç—ã (–µ—Å–ª–∏ –Ω–µ—Ç texts.json) -----
const fallbackTexts = [
  { text: "I morges sprang jeg hurtigt ud af sengen, og pr√∏vede jeg at finde mine sko, men de l√• gemt under sofaen. Da jeg endelig fandt dem, l√∏b jeg ud af d√∏ren og n√•ede lige bussen i sidste √∏jeblik." },
  { text: "I weekenden besluttede vi os for at tage en tur til havet. Vejret var fantastisk, solen skinnede, og luften var frisk. Vi pakkede madkurven, tog t√¶pper og k√∏rte af sted tidligt om morgenen. P√• stranden var der n√¶sten ingen mennesker." },
  { text: "Jeg har altid haft en svaghed for gamle b√∏ger. Sidste uge fandt jeg en lille antikboghandel i en sidegade, hvor tiden n√¶sten stod stille. Der lugtede af st√∏v og papir, og p√• hylderne stod b√∏ger, der var √¶ldre end mine bedstefor√¶ldre." }
];

// ----- –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ -----
let texts = [];
let currentText = null;
let selectedWords = [];     // –≤—ã–±—Ä–∞–Ω–Ω—ã–µ —É–Ω–∏–∫–∞–ª—å–Ω—ã–µ —Å–ª–æ–≤–∞ –¥–ª—è —Å–∫—Ä—ã—Ç–∏—è
let availableWords = [];    // —Å–ª–æ–≤–∞ –≤ –±–∞–Ω–∫–µ –¥–ª—è –≤—Å—Ç–∞–≤–∫–∏
let dragged = null;
let fromChoice = false;
let mobileMode = false;
let selectedWordForTap = null;

// –ü–æ–ø—ã—Ç–∫–∞ –∑–∞–≥—Ä—É–∑–∏—Ç—å texts.json, –∏–Ω–∞—á–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å fallback
fetch('texts.json')
  .then(r => { if(!r.ok) throw 0; return r.json(); })
  .then(data => { texts = data.length ? data : fallbackTexts; loadRandomText(); })
  .catch(() => { texts = fallbackTexts; loadRandomText(); });

// ---- –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–µ ----
function shuffleArray(arr){ return arr.slice().sort(()=>Math.random()-0.5); }

// ---- –ó–∞–≥—Ä—É–∑–∫–∞ —Å–ª—É—á–∞–π–Ω–æ–≥–æ —Ç–µ–∫—Å—Ç–∞ ----
function loadRandomText(){
  const i = Math.floor(Math.random()*texts.length);
  currentText = JSON.parse(JSON.stringify(texts[i])); // –∫–æ–ø–∏—è
  generateWords();
}

// ---- –ì–µ–Ω–µ—Ä–∞—Ü–∏—è —Å–ª—É—á–∞–π–Ω—ã—Ö —É–Ω–∏–∫–∞–ª—å–Ω—ã—Ö —Å–ª–æ–≤ (—Ç–æ–ª—å–∫–æ num) ----
function generateWords(){
  const num = Math.max(1, parseInt(document.getElementById('numWords').value) || 1);
  // –∏–∑–≤–ª–µ–∫–∞–µ–º —Å–ª–æ–≤–∞ (–±–µ—Ä—ë–º –±—É–∫–≤—ã –∏ √¶√∏√•)
  let allWords = currentText.text.match(/\b[\w√¶√∏√•√Ü√ò√Ö]+\b/g) || [];
  const unique = [...new Set(allWords)]; // —É–Ω–∏–∫–∞–ª—å–Ω—ã–µ
  selectedWords = shuffleArray(unique).slice(0, Math.min(num, unique.length));
  availableWords = selectedWords.slice();
  selectedWordForTap = null;
  renderStory();
  renderWords();
  document.getElementById('result').textContent = '';
}

// ---- renderStory: –∑–∞–º–µ–Ω–∏—Ç—å –¢–û–õ–¨–ö–û –ü–ï–†–í–û–ï –≤—Ö–æ–∂–¥–µ–Ω–∏–µ –∫–∞–∂–¥–æ–≥–æ –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ —Å–ª–æ–≤–∞ ----
function renderStory(){
  let html = currentText.text;
  selectedWords.forEach(word=>{
    const esc = word.replace(/[.*+?^${}()|[\]\\]/g,'\\$&');
    // –∑–∞–º–µ–Ω—è–µ–º —Ç–æ–ª—å–∫–æ –ü–ï–†–í–û–ï –≤—Ö–æ–∂–¥–µ–Ω–∏–µ (–±–µ–∑ —Ñ–ª–∞–≥–∞ g)
    const re = new RegExp(`\\b${esc}\\b`);
    html = html.replace(re, `<span class="placeholder" ondrop="dropWord(event)" ondragover="allowDrop(event)" onclick="tapPlaceholder(event)">___</span>`);
  });
  document.getElementById('story').innerHTML = html;
}

// ---- renderWords: –æ—Ç—Ä–∏—Å–æ–≤–∞—Ç—å –±–∞–Ω–∫ —Å–ª–æ–≤ ----
function renderWords(){
  const choices = document.getElementById('choices');
  choices.innerHTML = '';
  // –ø–µ—Ä–µ–º–µ—à–∞–µ–º –ø–µ—Ä–µ–¥ –ø–æ–∫–∞–∑–æ–º
  const shuffled = shuffleArray(availableWords);
  shuffled.forEach((w, idx) => {
    const div = document.createElement('div');
    div.className = 'word';
    div.textContent = w;
    // draggable —Ç–æ–ª—å–∫–æ –∫–æ–≥–¥–∞ –Ω–µ mobileMode
    if(!mobileMode){
      div.setAttribute('draggable','true');
      div.ondragstart = dragWord;
    } else {
      div.removeAttribute('draggable');
    }
    div.onclick = tapWord;
    choices.appendChild(div);
  });
}

// ---- Drag & Drop (Desktop mode) ----
function allowDrop(ev){ ev.preventDefault(); }
function dragWord(ev){
  if(mobileMode) return;
  dragged = ev.target;
  fromChoice = true;
  ev.dataTransfer.setData('text', ev.target.textContent);
  ev.target.classList.add('dragging');
}
// dropWord: –µ–¥–∏–Ω–æ–æ–±—Ä–∞–∑–Ω–∞—è –≤—Å—Ç–∞–≤–∫–∞ -> —Å–æ–∑–¥–∞—ë–º span.insertedWord —Å data-word
function dropWord(ev){
  if(mobileMode) return;
  ev.preventDefault();
  const placeholder = ev.target;
  if(!dragged) return;
  const wordText = dragged.textContent.trim();
  const span = document.createElement('span');
  span.className = 'insertedWord';
  span.textContent = wordText;
  span.dataset.word = wordText.toLowerCase();
  span.setAttribute('draggable','true');
  span.ondragstart = dragInsertedWord;
  span.onclick = tapInsertedWord;
  placeholder.parentNode.replaceChild(span, placeholder);
  // —É–±—Ä–∞—Ç—å –∏–∑ availableWords –µ—Å–ª–∏ –≤–∑—è–ª–∏ –∏–∑ –±–∞–Ω–∫–∞
  if(fromChoice){
    const idx = availableWords.indexOf(wordText);
    if(idx > -1) availableWords.splice(idx,1);
    renderWords();
  }
  if(dragged) dragged.classList.remove('dragging');
  dragged = null;
}
// dragInsertedWord: –≤–µ—Ä–Ω—É—Ç—å –≤ –±–∞–Ω–∫ (desktop)
function dragInsertedWord(ev){
  if(mobileMode) return;
  const el = ev.target;
  dragged = el;
  fromChoice = false;
  ev.dataTransfer.setData('text', el.textContent);
  el.classList.add('dragging');
  // –≤–µ—Ä–Ω—É—Ç—å —Å–ª–æ–≤–æ –≤ –±–∞–Ω–∫ –¥–ª—è –≤—ã–±–æ—Ä–∞
  availableWords.push(el.textContent.trim());
  renderWords();
  // –∑–∞–º–µ–Ω–∏—Ç—å —Ç–µ–∫—É—â–∏–π span –Ω–∞ placeholder
  const placeholder = document.createElement('span');
  placeholder.className = 'placeholder';
  placeholder.textContent = '___';
  placeholder.ondrop = dropWord;
  placeholder.ondragover = allowDrop;
  placeholder.onclick = tapPlaceholder;
  el.parentNode.replaceChild(placeholder, el);
  dragged = null;
}

// ---- Mobile TAP mode ----
function tapWord(ev){
  // –∫–ª–∏–∫ –ø–æ —Å–ª–æ–≤—É –≤ –±–∞–Ω–∫–µ
  const w = ev.currentTarget.textContent.trim();
  if(!mobileMode) return;
  // toggle selection
  if(selectedWordForTap === w){
    selectedWordForTap = null;
    ev.currentTarget.style.background = ''; // —Å–±—Ä–æ—Å –ø–æ–¥—Å–≤–µ—Ç–∫–∏
  } else {
    selectedWordForTap = w;
    // –ø–æ–¥—Å–≤–µ—Ç–∏—Ç—å –≤—ã–±—Ä–∞–Ω–Ω–æ–µ —Å–ª–æ–≤–æ
    document.querySelectorAll('#choices .word').forEach(el => el.style.background = '');
    ev.currentTarget.style.background = '#1976D2';
  }
}
function tapPlaceholder(ev){
  if(!mobileMode) return;
  if(!selectedWordForTap) return;
  const placeholder = ev.target;
  // —Å–æ–∑–¥–∞—ë–º –µ–¥–∏–Ω–æ–æ–±—Ä–∞–∑–Ω—ã–π inserted span
  const span = document.createElement('span');
  span.className = 'insertedWord';
  span.textContent = selectedWordForTap;
  span.dataset.word = selectedWordForTap.toLowerCase();
  span.onclick = tapInsertedWord;
  // –≤ –º–æ–±. —Ä–µ–∂–∏–º–µ - –Ω–µ draggable
  span.removeAttribute('draggable');
  placeholder.parentNode.replaceChild(span, placeholder);
  // —É–¥–∞–ª–∏—Ç—å —Å–ª–æ–≤–æ –∏–∑ –±–∞–Ω–∫–∞ available
  const idx = availableWords.indexOf(selectedWordForTap);
  if(idx > -1) availableWords.splice(idx, 1);
  selectedWordForTap = null;
  renderWords();
  // —É–±—Ä–∞—Ç—å –ø–æ–¥—Å–≤–µ—Ç–∫—É
  document.querySelectorAll('#choices .word').forEach(el => el.style.background = '');
}
function tapInsertedWord(ev){
  if(!mobileMode) return;
  const el = ev.target;
  const word = el.textContent.trim();
  // –≤–µ—Ä–Ω—É—Ç—å —Å–ª–æ–≤–æ –≤ –±–∞–Ω–∫
  availableWords.push(word);
  renderWords();
  // –∑–∞–º–µ–Ω–∏—Ç—å –Ω–∞ placeholder
  const placeholder = document.createElement('span');
  placeholder.className = 'placeholder';
  placeholder.textContent = '___';
  placeholder.ondrop = dropWord;
  placeholder.ondragover = allowDrop;
  placeholder.onclick = tapPlaceholder;
  el.parentNode.replaceChild(placeholder, el);
}

// ---- –ù–∞–¥—ë–∂–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ (—Ä–µ–≥–∏—Å—Ç—Ä–æ–Ω–µ–∑–∞–≤–∏—Å–∏–º–æ, –ø–æ —Å–æ–¥–µ—Ä–∂–∏–º–æ–º—É, —É–Ω–∏–∫–∞–ª—å–Ω–æ) ----
document.getElementById('check').addEventListener('click', () => {
  const storyEl = document.getElementById('story');
  // –≤—Å–µ span –≤ —Ç–µ–∫—Å—Ç–µ (–∏ placeholder —Ç–æ–∂–µ), –Ω–æ —Å—á–∏—Ç–∞–µ–º –≤—Å—Ç–∞–≤–ª–µ–Ω–Ω—ã–º–∏ —Ç–æ–ª—å–∫–æ —Ä–µ–∞–ª—å–Ω—ã–µ insertedWord
  const insertedEls = Array.from(storyEl.querySelectorAll('span.insertedWord'));
  const insertedTextsLower = insertedEls.map(s => s.textContent.trim().toLowerCase()).filter(t => t !== '');

  const insertedSet = new Set(insertedTextsLower);
  const expectedSet = new Set(selectedWords.map(w => w.toLowerCase()));

  // –ü–æ–¥—Å–≤–µ—Ç–∫–∞ –≤—Å—Ç–∞–≤–ª–µ–Ω–Ω—ã—Ö —ç–ª–µ–º–µ–Ω—Ç–æ–≤: –∑–µ–ª—ë–Ω—ã–π –µ—Å–ª–∏ –≤—Ö–æ–¥–∏—Ç –≤ expected, –∏–Ω–∞—á–µ –∫—Ä–∞—Å–Ω—ã–π
  insertedEls.forEach(el=>{
    const t = el.textContent.trim().toLowerCase();
    if(expectedSet.has(t)){
      el.style.background = '#4CAF50';
      el.style.borderBottom = '2px solid green';
    } else {
      el.style.background = '#f44336';
      el.style.borderBottom = '2px solid darkred';
    }
  });

  const allFilled = insertedEls.length === selectedWords.length;
  const allMatched = allFilled && insertedSet.size === expectedSet.size && [...expectedSet].every(w => insertedSet.has(w));

  const resultEl = document.getElementById('result');
  if(allMatched){
    resultEl.textContent = 'Alle svar er korrekte! üéâ';
    resultEl.style.color = 'green';
  } else {
    const correctUnique = [...insertedSet].filter(w => expectedSet.has(w)).length;
    resultEl.textContent = `üîπ Du har ${correctUnique} korrekte ord ud af ${expectedSet.size}.`;
    resultEl.style.color = 'orange';
  }
});

// ---- –ö–Ω–æ–ø–∫–∏ –∏ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ ----
document.getElementById('refresh').addEventListener('click', loadRandomText);
document.getElementById('generateWords').addEventListener('click', generateWords);
document.getElementById('mobileMode').addEventListener('change', (e)=>{
  mobileMode = e.target.checked;
  selectedWordForTap = null;
  // –ø—Ä–∏ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–∏ —Ä–µ–∂–∏–º–∞ –¥–µ–ª–∞–µ–º –ø–æ–≤—Ç–æ—Ä–Ω—ã–π —Ä–µ–Ω–¥–µ—Ä —Å–ª–æ–≤ (draggable / not)
  renderWords();
});

</script>
</body>
</html>
