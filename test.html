<!DOCTYPE html>
<html lang="da">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Ordtr√¶ning</title>
<style>
body {
  font-family: system-ui, sans-serif;
  background: #f2f2f2;
  margin: 0;
  padding: 20px;
}
h2 { color: #333; text-align: center; }

#controls {
  text-align: center;
  margin-bottom: 20px;
}
#controls label {
  margin-right: 15px;
}
#controls input[type="number"] {
  width: 60px;
  text-align: center;
}

#story {
  background: #fff;
  padding: 20px;
  border-radius: 10px;
  box-shadow: 0 2px 5px rgba(0,0,0,0.1);
  line-height: 1.6;
  font-size: 18px;
}

.placeholder, .insertedWord {
  display: inline-block;
  min-width: 60px;
  padding: 5px;
  margin: 0 3px;
  border-bottom: 2px solid #555;
  vertical-align: middle;
  text-align: center;
}
.placeholder { background: #fff; cursor: grab; }
.insertedWord { background: #2196F3; color: #fff; cursor: grab; border-radius: 4px; }

#choices {
  margin-top: 20px;
  min-height: 60px;
  padding: 10px;
  border: 1px solid #ccc;
  background: #e9e9e9;
  border-radius: 5px;
  text-align: center;
}
.word {
  display: inline-block;
  padding: 8px 12px;
  margin: 5px;
  background: #4CAF50;
  color: #fff;
  border-radius: 5px;
  cursor: grab;
  user-select: none;
}
.word.dragging, .insertedWord.dragging { opacity: 0.5; }

#check, #refresh, #generateWords {
  padding: 10px 20px;
  font-size: 16px;
  cursor: pointer;
  margin: 5px;
}

#result {
  margin-top: 15px;
  font-weight: bold;
  font-size: 18px;
  text-align: center;
}
@media (max-width: 768px) {
  body { padding: 10px; }
  #story { font-size: 16px; }
  .word { font-size: 15px; padding: 6px 10px; }
}
</style>
</head>
<body>

<h2>Udfyld de manglende ord:</h2>

<div id="controls">
  <label>Antal ord: <input type="number" id="numWords" min="1" max="10" value="3"></label>
  <label><input type="checkbox" id="mobileMode"> Mobiltilstand</label>
  <button id="generateWords">Generer ord</button>
  <button id="refresh">Opdater tekst</button>
  <button id="check">Check</button>
</div>

<div id="story"></div>
<div id="choices"></div>
<div id="result"></div>

<script>
let texts = [];
let currentText = null;
let availableWords = [];
let selectedWords = [];
let dragged = null;
let fromChoice = false;
let mobileMode = false;
let selectedWordForTap = null;

// === –ó–∞–≥—Ä—É–∑–∫–∞ JSON —Å —Ä–∞—Å—Å–∫–∞–∑–∞–º–∏ ===
fetch('texts.json')
  .then(res => res.json())
  .then(data => {
    texts = data;
    loadRandomText();
  });

// === –í—ã–±–æ—Ä —Å–ª—É—á–∞–π–Ω–æ–≥–æ —Ç–µ–∫—Å—Ç–∞ ===
function loadRandomText() {
  const randomIndex = Math.floor(Math.random() * texts.length);
  currentText = JSON.parse(JSON.stringify(texts[randomIndex]));
  generateWords();
}

// === –ü–µ—Ä–µ–º–µ—à–∏–≤–∞–Ω–∏–µ –º–∞—Å—Å–∏–≤–∞ ===
function shuffleArray(arr) {
  return arr.slice().sort(() => Math.random() - 0.5);
}

// === –ì–µ–Ω–µ—Ä–∞—Ü–∏—è —Å–ª—É—á–∞–π–Ω—ã—Ö —Å–ª–æ–≤ ===
function generateWords() {
  const num = parseInt(document.getElementById('numWords').value);
  let allWords = currentText.text.match(/\b[\w√¶√∏√•√Ü√ò√Ö]+\b/g);
  if(!allWords) allWords = [];

  // –£–±–∏—Ä–∞–µ–º –¥—É–±–ª–∏–∫–∞—Ç—ã
  const uniqueWords = [...new Set(allWords)];
  selectedWords = shuffleArray(uniqueWords).slice(0, Math.min(num, uniqueWords.length));
  availableWords = selectedWords.slice();

  renderStory();
  renderWords();
  document.getElementById('result').textContent = '';
}

// === –°–æ–∑–¥–∞–Ω–∏–µ —Ç–µ–∫—Å—Ç–∞ —Å placeholders ===
function renderStory() {
  let newText = currentText.text;
  selectedWords.forEach(word => {
    const escapedWord = word.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
    const regex = new RegExp(`\\b${escapedWord}\\b`, '');
    newText = newText.replace(regex, '<span class="placeholder" ondrop="dropWord(event)" ondragover="allowDrop(event)" onclick="tapPlaceholder(event)">___</span>');
  });
  document.getElementById('story').innerHTML = newText;
}

// === –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –¥–æ—Å—Ç—É–ø–Ω—ã—Ö —Å–ª–æ–≤ ===
function renderWords() {
  const choicesDiv = document.getElementById('choices');
  choicesDiv.innerHTML = availableWords.map((w,i) =>
    `<div class="word" draggable="true" id="word${i}" 
      ondragstart="dragWord(event)" onclick="tapWord(event)">${w}</div>`
  ).join('');
}

// === Drag & Drop ===
function allowDrop(ev){ ev.preventDefault(); }

function dragWord(ev){
  if (mobileMode) return;
  dragged = ev.target;
  fromChoice = true;
  ev.dataTransfer.setData("text", ev.target.textContent);
  ev.target.classList.add('dragging');
}

// === –í—Å—Ç–∞–≤–∫–∞ —Å–ª–æ–≤–∞ –ø—Ä–∏ drag&drop (–∏ –¥–ª—è –æ–±—ã—á–Ω–æ–≥–æ —Ä–µ–∂–∏–º–∞) ===
function dropWord(ev){
  if (mobileMode) return; // –≤ –º–æ–±–∏–ª. —Ä–µ–∂–∏–º–µ DnD –æ—Ç–∫–ª—é—á—ë–Ω
  ev.preventDefault();
  const placeholder = ev.target;
  if(!dragged) return;

  // —Å–æ–∑–¥–∞—ë–º –µ–¥–∏–Ω–æ–æ–±—Ä–∞–∑–Ω—ã–π span-—ç–ª–µ–º–µ–Ω—Ç –¥–ª—è –≤—Å—Ç–∞–≤–ª–µ–Ω–Ω–æ–≥–æ —Å–ª–æ–≤–∞
  const span = document.createElement('span');
  span.className = 'insertedWord';
  span.setAttribute('draggable', 'true');
  span.textContent = dragged.textContent.trim();
  span.dataset.word = dragged.textContent.trim().toLowerCase();
  span.ondragstart = dragInsertedWord;
  span.onclick = tapInsertedWord;

  placeholder.parentNode.replaceChild(span, placeholder);

  if(fromChoice){
    const idx = availableWords.indexOf(dragged.textContent);
    if(idx > -1) availableWords.splice(idx, 1);
    renderWords();
  }

  if (dragged) dragged.classList.remove('dragging');
  dragged = null;
}

// === –ù–∞—á–∞–ª–æ –ø–µ—Ä–µ—Ç–∞—Å–∫–∏–≤–∞–Ω–∏—è —É–∂–µ –≤—Å—Ç–∞–≤–ª–µ–Ω–Ω–æ–≥–æ —Å–ª–æ–≤–∞ (–≤–æ–∑–≤—Ä–∞—Ç –≤ choices) ===
function dragInsertedWord(ev){
  if (mobileMode) return;
  const wordEl = ev.target;
  dragged = wordEl;
  fromChoice = false;
  ev.dataTransfer.setData("text", wordEl.textContent);
  ev.target.classList.add('dragging');

  // –≤–µ—Ä–Ω—É—Ç—å —Å–ª–æ–≤–æ –≤ –±–∞–Ω–∫ —Å–ª–æ–≤
  availableWords.push(wordEl.textContent.trim());
  renderWords();

  // –∑–∞–º–µ–Ω–∏—Ç—å —Ç–µ–∫—É—â–∏–π span –Ω–∞ placeholder
  const placeholder = document.createElement('span');
  placeholder.className = 'placeholder';
  placeholder.textContent = '___';
  placeholder.ondrop = dropWord;
  placeholder.ondragover = allowDrop;
  placeholder.onclick = tapPlaceholder;
  wordEl.parentNode.replaceChild(placeholder, wordEl);
  dragged = null;
}

// === TAP MODE ===
function tapWord(ev) {
  if (!mobileMode) return;
  const word = ev.target.textContent.trim();
  if (selectedWordForTap === word) {
    selectedWordForTap = null;
    ev.target.style.background = '#4CAF50';
  } else {
    selectedWordForTap = word;
    document.querySelectorAll('.word').forEach(w => w.style.background = '#4CAF50');
    ev.target.style.background = '#1976D2';
  }
}

function tapPlaceholder(ev) {
  if (!mobileMode || !selectedWordForTap) return;
  const placeholder = ev.target;
  // –µ–¥–∏–Ω–æ–æ–±—Ä–∞–∑–Ω—ã–π span
  const span = document.createElement('span');
  span.className = 'insertedWord';
  span.textContent = selectedWordForTap;
  span.dataset.word = selectedWordForTap.trim().toLowerCase();
  span.onclick = tapInsertedWord;
  span.setAttribute('draggable', mobileMode ? 'false' : 'true');

  placeholder.parentNode.replaceChild(span, placeholder);

  // —É–±—Ä–∞—Ç—å —Å–ª–æ–≤–æ –∏–∑ availableWords
  const index = availableWords.indexOf(selectedWordForTap);
  if(index > -1) availableWords.splice(index, 1);
  renderWords();
  selectedWordForTap = null;
  // —Å–±—Ä–æ—Å –ø–æ–¥—Å–≤–µ—Ç–æ–∫ —Å–ª–æ–≤ –≤ –±–∞–Ω–∫–µ
  document.querySelectorAll('#choices .word').forEach(el => el.style.background = '');
}

function tapInsertedWord(ev) {
  if (!mobileMode) return;
  const wordEl = ev.target;
  const wordText = wordEl.textContent.trim();
  // –≤–µ—Ä–Ω—É—Ç—å –≤ availableWords
  availableWords.push(wordText);
  renderWords();

  // –∑–∞–º–µ–Ω–∏—Ç—å –Ω–∞ placeholder
  const placeholder = document.createElement('span');
  placeholder.className = 'placeholder';
  placeholder.textContent = '___';
  placeholder.ondrop = dropWord;
  placeholder.ondragover = allowDrop;
  placeholder.onclick = tapPlaceholder;
  wordEl.parentNode.replaceChild(placeholder, wordEl);
}

// === –ù–∞–¥—ë–∂–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞: —É–Ω–∏–∫–∞–ª—å–Ω—ã–µ —Å–ª–æ–≤–∞, —Ä–µ–≥–∏—Å—Ç—Ä –∏–≥–Ω–æ—Ä–∏—Ä—É–µ—Ç—Å—è ===
document.getElementById('check').addEventListener('click', () => {
  const storyEl = document.getElementById('story');
  // —Å–æ–±–∏—Ä–∞–µ–º –≤—Å–µ span-—ã –≤–Ω—É—Ç—Ä–∏ —Ç–µ–∫—Å—Ç–∞, —Å—á–∏—Ç–∞–µ–º –∫–∞–∫ –≤—Å—Ç–∞–≤–ª–µ–Ω–Ω—ã–µ —Ç–µ, —É –∫–æ—Ç–æ—Ä—ã—Ö —Ç–µ–∫—Å—Ç –Ω–µ–ø—É—Å—Ç–æ–π –∏ –∫–æ—Ç–æ—Ä—ã–µ –Ω–µ placeholder
  const allSpans = Array.from(storyEl.querySelectorAll('span'));
  const insertedEls = allSpans.filter(s => s.classList.contains('insertedWord') || (s.classList.contains('placeholder') === false && s.textContent.trim() !== ''));

  const insertedTextsLower = insertedEls.map(el => el.textContent.trim().toLowerCase()).filter(t => t !== '');
  const insertedSet = new Set(insertedTextsLower); // —É–Ω–∏–∫–∞–ª—å–Ω—ã–µ –≤—Å—Ç–∞–≤–ª–µ–Ω–Ω—ã–µ —Å–ª–æ–≤–∞

  const expectedSet = new Set(selectedWords.map(w => w.toLowerCase()));

  // –ü–æ–¥—Å–≤–µ—Ç–∫–∞: –∑–µ–ª—ë–Ω—ã–π –µ—Å–ª–∏ –≤—Å—Ç–∞–≤–ª–µ–Ω–Ω–æ–µ —Å–ª–æ–≤–æ –µ—Å—Ç—å –≤ expectedSet, –∏–Ω–∞—á–µ –∫—Ä–∞—Å–Ω—ã–π
  insertedEls.forEach(el => {
    const txt = el.textContent.trim().toLowerCase();
    if (expectedSet.has(txt)) {
      el.style.background = '#4CAF50';
      el.style.borderBottom = '2px solid green';
    } else {
      el.style.background = '#f44336';
      el.style.borderBottom = '2px solid darkred';
    }
  });

  const resultEl = document.getElementById('result');

  // –≤—Å–µ –ø–æ–ª—è –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å –∑–∞–ø–æ–ª–Ω–µ–Ω—ã (–∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –≤—Å—Ç–∞–≤–ª–µ–Ω–Ω—ã—Ö —ç–ª–µ–º–µ–Ω—Ç–æ–≤ === –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –≤—ã–±—Ä–∞–Ω–Ω—ã—Ö —Å–ª–æ–≤)
  const allFilled = insertedTextsLower.length === selectedWords.length;

  // –º–Ω–æ–∂–µ—Å—Ç–≤–æ —É–Ω–∏–∫–∞–ª—å–Ω–æ –≤—Å—Ç–∞–≤–ª–µ–Ω–Ω—ã—Ö —Å–ª–æ–≤ –¥–æ–ª–∂–Ω–æ —Å–æ–≤–ø–∞–¥–∞—Ç—å —Å expectedSet
  const allMatched = allFilled &&
    insertedSet.size === expectedSet.size &&
    [...expectedSet].every(w => insertedSet.has(w));

  if (allMatched) {
    resultEl.textContent = 'Alle svar er korrekte! üéâ';
    resultEl.style.color = 'green';
  } else {
    const correctUnique = [...insertedSet].filter(w => expectedSet.has(w)).length;
    resultEl.textContent = `üîπ Du har ${correctUnique} korrekte ord ud af ${expectedSet.size}.`;
    resultEl.style.color = 'orange';
  }
});


// === –ö–Ω–æ–ø–∫–∏ ===
document.getElementById('refresh').addEventListener('click', loadRandomText);
document.getElementById('generateWords').addEventListener('click', generateWords);
document.getElementById('mobileMode').addEventListener('change', e => {
  mobileMode = e.target.checked;
  selectedWordForTap = null;
});
</script>
</body>
</html>
